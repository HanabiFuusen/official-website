---
const pathname = Astro.url.pathname

const navLinks = [
  { href: '/', labelKey: 'nav.top', labelDescrKey: 'nav.topDescr' },
  { href: '/news', labelKey: 'nav.news', labelDescrKey: 'nav.newsDescr' },
  { href: '/games', labelKey: 'nav.games', labelDescrKey: 'nav.gamesDescr' },
]

const socialLinks = [
  { 
    href: 'https://twitter.com/hanabifuusen', 
    label: 'X',
    icon: 'M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z'
  },
  { 
    href: 'https://instagram.com/hanabifuusen', 
    label: 'Instagram',
    icon: 'M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37zm1.5-4.87h.01M7.5 2h9a5.5 5.5 0 015.5 5.5v9a5.5 5.5 0 01-5.5 5.5h-9A5.5 5.5 0 012 16.5v-9A5.5 5.5 0 017.5 2z'
  },
  { 
    href: 'https://facebook.com/hanabifuusen', 
    label: 'Facebook',
    icon: 'M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z'
  },
]

const languages = [
  { code: 'ja', label: '日本語' },
  { code: 'zh-TW', label: '繁體中文' },
  { code: 'en', label: 'English' },
  ...(import.meta.env.DEV ? [{ code: 'dev', label: 'DEV' }] : []),
]
---

<nav class="fixed top-0 left-0 right-0 z-50 bg-gray-950/95 backdrop-blur-md">
  <div class="max-w-full mx-auto">
    <!-- 第一層：Logo 和社群媒體 -->
    <div class="flex items-center justify-between h-15  px-4 sm:px-6 lg:px-8" style="background-color: var(--color-navbar-layer1);">
      <!-- 左側空白 (用於保持 logo 居中) -->
      <div class="flex-1 hidden nav:block"></div>
      
      <!-- 中間 Logo -->
      <a href="/" class="flex flex-col items-center justify-center group">
        <img src="/images/logo.png" alt="HanabiFuusen" class="h-10 w-auto mb-1" />
      </a>

      <!-- 右側區域 -->
      <div class="flex-1 flex items-center justify-end gap-4">
        <!-- 社群媒體圖示 -->
        {socialLinks.map((social) => (
          <a
            href={social.href}
            target="_blank"
            rel="noopener noreferrer"
            class="text-gray-400 hover:text-pink-400 transition-colors"
            aria-label={social.label}
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
              <path d={social.icon} />
            </svg>
          </a>
        ))}
        
        <!-- Mobile Menu Button -->
        <button
          id="mobile-menu-btn"
          class="nav:hidden p-2 text-gray-300 focus:outline-none"
          aria-label="選擇語言"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
          </svg>
        </button>
      </div>
    </div>

    <!-- 第二層：導航連結和語言切換 -->
    <div class="flex items-center justify-between h-12 px-4" style="background-color: var(--color-navbar-layer2); box-shadow: 0 -1px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 6px -1px rgb(0 0 0 / 0.4);">
      <!-- 左側空白保持居中 -->
      <div class="flex-1 hidden nav:block"></div>
      
      <!-- 中間導航連結 -->
      <ul class="flex items-center h-full flex-1 nav:flex-none justify-center nav:justify-start w-full nav:w-auto">
        {navLinks.map((link, index) => (
          <li class="h-full relative flex-1 nav:flex-none">
            {index === 0 && (
              <div class="absolute left-0 top-[5px] bottom-[5px] w-[2px] bg-white"></div>
            )}
            <a
              href={link.href}
              class="flex flex-col items-center justify-center h-full px-3 nav:px-6 transition-colors text-white w-full nav:w-[200px] min-w-0 hover:bg-white/20"
            >
              <span class="text-sm nav:text-lg font-bold hover:underline leading-none" data-i18n={link.labelKey}></span>
              <span class="text-[8px] nav:text-[10px] text-gray-100/70 leading-none mt-0.25" data-i18n={link.labelDescrKey}></span>
            </a>
            <div class="absolute right-0 top-[5px] bottom-[5px] w-[2px] bg-white"></div>
          </li>
        ))}
      </ul>
      
      <!-- 右側語言切換 -->
      <div class="flex-1 flex justify-end hidden nav:flex">
        <div class="relative">
          <button
            id="language-btn"
            class="flex items-center gap-2 px-3 py-1.5 text-sm text-gray-300 hover:text-white bg-gray-800/50 hover:bg-gray-800 rounded-lg transition-colors"
            aria-label="選擇語言"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
            </svg>
            <span id="current-language">繁中</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <!-- 語言下拉選單 -->
          <div
            id="language-menu"
            class="hidden absolute right-0 mt-2 w-40 bg-gray-900 rounded-lg shadow-xl border border-gray-800 overflow-hidden z-50"
          >
            {languages.map((lang) => (
              <button
                data-lang={lang.code}
                class="language-option w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors text-left"
              >
                <span>{lang.label}</span>
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-menu" class="hidden nav:hidden pb-4">
      <ul class="flex flex-col gap-2">
        <!-- 移動版語言選項 -->
        <li class="mt-2 pt-2">
          <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase">語言 / Language</div>
          {languages.map((lang) => (
            <button
              data-lang={lang.code}
              class="mobile-language-option w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition-colors text-left cursor-pointer"
            >
              <span>{lang.label}</span>
            </button>
          ))}
        </li>
      </ul>
    </div>
  </div>
</nav>

<script>
  import { updateContent, getCurrentLanguage } from '../scripts/i18n'
  
  const menuBtn = document.getElementById('mobile-menu-btn')
  const mobileMenu = document.getElementById('mobile-menu')
  const languageBtn = document.getElementById('language-btn')
  const languageMenu = document.getElementById('language-menu')
  const currentLanguageSpan = document.getElementById('current-language')
  const languageOptions = document.querySelectorAll('.language-option')

  // Mobile menu toggle
  menuBtn?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden')
  })

  // Language menu toggle
  languageBtn?.addEventListener('click', (e) => {
    e.stopPropagation()
    languageMenu?.classList.toggle('hidden')
  })

  // Close language menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!languageBtn?.contains(e.target as Node) && !languageMenu?.contains(e.target as Node)) {
      languageMenu?.classList.add('hidden')
    }
  })

  // Use getCurrentLanguage from i18n.ts
  const savedLang = getCurrentLanguage()
  
  const langLabels: Record<string, string> = {
    'ja': '日本語',
    'zh-TW': '繁中',
    'en': 'EN',
    'dev': 'DEV',
  }
  if (currentLanguageSpan) {
    currentLanguageSpan.textContent = langLabels[savedLang] || '繁中'
  }

  // Language selection (desktop)
  languageOptions.forEach((option) => {
    option.addEventListener('click', () => {
      const langCode = option.getAttribute('data-lang')
      if (langCode && currentLanguageSpan) {
        localStorage.setItem('language', langCode)
        
        // Update URL with language parameter and reload
        const url = new URL(window.location.href)
        url.searchParams.set('lang', langCode)
        window.location.href = url.toString()
      }
    })
  })
  
  // Language selection (mobile)
  const mobileLangOptions = document.querySelectorAll('.mobile-language-option')
  mobileLangOptions.forEach((option) => {
    option.addEventListener('click', () => {
      const langCode = option.getAttribute('data-lang')
      if (langCode) {
        localStorage.setItem('language', langCode)
        
        // Update URL with language parameter and reload
        const url = new URL(window.location.href)
        url.searchParams.set('lang', langCode)
        window.location.href = url.toString()
      }
    })
  })
  
  // Update navigation text with translations
  updateContent()
</script>

---
import Layout from '../layouts/Layout.astro'
import GameCard from '../components/GameCard.astro'
import { newsList } from '../data/news'

// 取得最新5筆 News
const latestNews = newsList.slice(0, 5)

const featuredGames = [
  {
    id: 'game01',
    titleKey: 'home.featuredGame.title',
    descriptionKey: 'home.featuredGame.description',
    tagsKeys: ['games.tags.adventure', 'games.tags.puzzle'],
    image: '/images/game/game01/cover.png',
  },
  {
    id: 'game02',
    titleKey: '進擊吧，魅魔軍團！',
    descriptionKey: '',
    tagsKeys: ['games.tags.adventure'],
    image: '/images/game/game02/cover.png',
  },
  {
    id: 'comming_soon',
    titleKey: 'common.comingSoon',
    descriptionKey: 'common.comingSoon',
    tagsKeys: [],
    image: '/images/game/coming_soon.png',
  },
]

const otherGames: Array<{
  id: string
  title: string
  description: string
  image: string
  platforms: ('steam' | 'switch')[]
}> = [
  {
    id: 'game01',
    title: '帶我去城下城吧！！',
    description: '成人向版本',
    image: '/images/game/game01/cover.png',
    platforms: ['steam'],
  },
  {
    id: 'game02',
    title: '帶我去城下城吧！！',
    description: '一般向',
    image: '/images/game/game02/cover.png',
    platforms: ['switch'],
  },
  {
    id: 'comming_soon',
    title: '即將推出',
    description: '即將推出',
    image: '/images/game/coming_soon.png',
    platforms: ['steam'],
  },
]
---

<Layout title="風船花火">
  <!-- Hero Section - 大型特色遊戲區域 -->
  <section class="pt-34 pb-0 max-w-4xl mx-auto">
    <!-- 16:9 遊戲封面輪播 - 外層容器包含箭頭 -->
    <div class="relative max-w-4xl mx-auto px-5 overflow-hidden">
      <!-- 輪播視窗 - 堆疊式卡片 -->
      <div id="carousel-container" class="relative aspect-video ">
        {featuredGames.map((game, index) => (
          <div 
            class="carousel-slide absolute inset-0 transition-all duration-700 ease-out rounded-xl overflow-hidden"
            data-index={index}
            style={`z-index: ${index === 0 ? 30 : 10}; 
                  transform: ${index === 0 ? 'translateX(0) scale(1)' : index === 1 ? 'translateX(85%) scale(0.9)' : 'translateX(-85%) scale(0.9)'};
                  box-shadow: 0 4px 20px 0px rgba(0, 0, 0, .3);
                  `}
          >
            <a href={`/games/${game.id}`} class="block h-full group" style="">
              <!-- 背景圖片 -->
              <div class="absolute inset-0">
                <img 
                  src={game.image}
                  alt={game.titleKey}
                  class="w-full h-full object-cover"
                />
                <!-- 漸層遮罩 - 讓文字更清晰 -->
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent" />
                
                <!-- 半透明遮罩 - 非中心卡片使用 -->
                <div class="carousel-overlay absolute inset-0 bg-black/50 transition-opacity duration-700 pointer-events-none opacity-0"></div>
              </div>

              <!-- 遊戲資訊內容 -->
              <div class="carousel-content relative h-full flex items-end transition-opacity duration-700">
                <div class="w-full max-w-4xl mx-auto px-6 pb-16">
                  <!-- 標籤 -->
                  <div class="flex gap-3 mb-4">
                    {game.tagsKeys.map((tagKey) => (
                      <span class="px-4 py-2 text-sm font-semibold bg-pink-500/30 text-pink-300 rounded-lg backdrop-blur-md border border-pink-400/30" data-i18n={tagKey}>
                      </span>
                    ))}
                  </div>

                  <!-- 遊戲標題 -->
                  <h1 class="text-4xl md:text-5xl font-black text-white mb-3 leading-tight drop-shadow-2xl" data-i18n={game.titleKey}>
                  </h1>

                  <!-- 遊戲描述 -->
                  <p class="text-lg text-gray-200 mb-6 max-w-2xl drop-shadow-lg" data-i18n={game.descriptionKey}>
                  </p>

                  <!-- 查看按鈕 -->
                  <span class="inline-flex items-center gap-3 px-6 py-3 bg-pink-500 hover:bg-pink-600 text-white font-bold text-base rounded-xl transition-all shadow-xl hover:shadow-2xl hover:scale-105">
                    <span data-i18n="home.featuredGame.playNow"></span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </span>
                </div>
              </div>
            </a>
          </div>
        ))}
      </div>

      <!-- 左右切換按鈕 - 在外面 -->
      <button 
        id="carousel-prev"
        class="absolute left-1 top-1/2 -translate-y-1/2 z-40 bg-white hover:bg-gray-100 text-gray-800 p-4 rounded-full shadow-lg transition-all hover:scale-110"
        aria-label="上一個"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <button 
        id="carousel-next"
        class="absolute right-1 top-1/2 -translate-y-1/2 z-40 bg-white hover:bg-gray-100 text-gray-800 p-4 rounded-full shadow-lg transition-all hover:scale-110"
        aria-label="下一個"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>

      <!-- Dot Navigation -->
      <div class="flex justify-center gap-2 mt-6">
        {featuredGames.map((_, index) => (
          <button
            class:list={[
              "carousel-dot w-3 h-3 rounded-full transition-all",
              index === 0 ? "bg-pink-500 w-8" : "bg-gray-400 hover:bg-gray-500"
            ]}
            data-index={index}
            aria-label={`前往遊戲 ${index + 1}`}
          >
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- 其他遊戲區域 -->
  <section class="pt-8 pb-10">
    <div class="max-w-4xl mx-auto px-6">
      <div class="relative mb-8">
        <span class="absolute left-0 right-0 h-3.5" style="top: calc(25px); background-color: var(--color-navbar-layer2); box-shadow: 5px 5px 0px 0px rgba(0, 0, 0, 0.1);"></span>
        <h2 class="relative text-3xl md:text-4xl font-bold text-gray-900 z-10 pl-3"><span data-i18n="home.moreGames">GAMES</span><span class="text-[16px] ml-2 inline-block relative -top-[calc(13.5px)]">ゲーム</span></h2>
      </div>
      
      <!-- 遊戲卡片網格 -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {otherGames.map((game) => (
          <GameCard 
            title={game.title}
            description={game.description}
            image={game.image}
            href={`/games/${game.id}`}
            platforms={game.platforms}
          />
        ))}
      </div>
    </div>
  </section>

  <!-- News 區域 -->
  <section class="py-16">
    <div class="max-w-4xl mx-auto px-6">
      <div class="relative mb-8">
        <span class="absolute left-0 right-0 top-6.5 h-3.5" style="background-color: var(--color-navbar-layer2); box-shadow: 5px 5px 0px 0px rgba(0, 0, 0, 0.1);"></span>
        <div class="relative z-10 flex items-center justify-between">
          <h2 class="relative text-3xl md:text-4xl font-bold text-gray-900 z-10 pl-3"><span data-i18n="news.title">NEWS</span><span class="text-[16px] ml-2 inline-block relative -top-[calc(13.5px)]">ニュース</span></h2>
          <a 
            href="/news" 
            class="text-pink-500 hover:text-pink-600 font-medium flex items-center gap-1 transition-colors"
          >
            <span data-i18n="home.viewAll">查看全部</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
      </div>
      
      <!-- News 列表 -->
      <div class="border border-gray-200 rounded-xl overflow-hidden bg-white">
        {latestNews.map((news, index) => (
          <a 
            href={`/news/${news.id}`}
            class:list={[
              "flex items-center gap-4 px-6 py-4 hover:bg-gray-50 transition-colors group",
              index !== latestNews.length - 1 && "border-b border-gray-200"
            ]}
          >
            <!-- 日期 -->
            <time class="text-sm text-gray-500 shrink-0 w-24">{news.date}</time>
            
            <!-- 標題 -->
            <h3 
              class="text-gray-900 group-hover:text-pink-600 transition-colors flex-1 truncate"
              data-i18n={news.titleKey}
            >
            </h3>
            
            <!-- 箭頭 -->
            <svg 
              class="w-5 h-5 text-gray-400 group-hover:text-pink-500 transition-colors shrink-0" 
              fill="none" 
              stroke="currentColor" 
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        ))}
      </div>
    </div>
  </section>
</Layout>

<script>
  import { updateContent } from '../scripts/i18n'
  updateContent()

  // Carousel functionality
  let currentIndex = 0
  const carouselSlides = document.querySelectorAll('.carousel-slide')
  const carouselDots = document.querySelectorAll('.carousel-dot')
  const prevBtn = document.getElementById('carousel-prev')
  const nextBtn = document.getElementById('carousel-next')
  const totalItems = carouselSlides.length

  function updateCarousel() {
    // 更新每張卡片的位置、層級和樣式
    carouselSlides.forEach((slide, i) => {
      const overlay = slide.querySelector('.carousel-overlay')
      const content = slide.querySelector('.carousel-content')
      
      // 計算相對位置 (-1 = 左邊, 0 = 中間, 1 = 右邊)
      let relativePos = i - currentIndex
      
      // 處理循環
      if (relativePos > totalItems / 2) relativePos -= totalItems
      if (relativePos < -totalItems / 2) relativePos += totalItems
      
      const slideEl = slide as HTMLElement
      
      if (relativePos === 0) {
        // 中央卡片 - 最上層，完整大小
        slideEl.style.transform = 'translateX(0) scale(1)'
        slideEl.style.zIndex = '30'
        overlay?.classList.add('opacity-0')
        content?.classList.remove('opacity-0')
      } else if (relativePos === 1 || (relativePos === -(totalItems - 1))) {
        // 右側卡片 - 露出左邊一部分，在中央卡片下面
        slideEl.style.transform = 'translateX(85%) scale(0.9)'
        slideEl.style.zIndex = '20'
        overlay?.classList.remove('opacity-0')
        content?.classList.add('opacity-0')
      } else if (relativePos === -1 || (relativePos === (totalItems - 1))) {
        // 左側卡片 - 露出右邊一部分，在中央卡片下面
        slideEl.style.transform = 'translateX(-85%) scale(0.9)'
        slideEl.style.zIndex = '20'
        overlay?.classList.remove('opacity-0')
        content?.classList.add('opacity-0')
      } else {
        // 其他卡片 - 隱藏
        slideEl.style.transform = relativePos > 0 ? 'translateX(100%) scale(0.8)' : 'translateX(-100%) scale(0.8)'
        slideEl.style.zIndex = '10'
        overlay?.classList.remove('opacity-0')
        content?.classList.add('opacity-0')
      }
    })

    // 更新 dots
    carouselDots.forEach((dot, i) => {
      if (i === currentIndex) {
        dot.classList.remove('bg-gray-400', 'w-3')
        dot.classList.add('bg-pink-500', 'w-8')
      } else {
        dot.classList.remove('bg-pink-500', 'w-8')
        dot.classList.add('bg-gray-400', 'w-3')
      }
    })
  }

  // 上一個按鈕
  prevBtn?.addEventListener('click', () => {
    currentIndex = currentIndex === 0 ? totalItems - 1 : currentIndex - 1
    updateCarousel()
  })

  // 下一個按鈕
  nextBtn?.addEventListener('click', () => {
    currentIndex = currentIndex === totalItems - 1 ? 0 : currentIndex + 1
    updateCarousel()
  })

  // Dot 點擊
  carouselDots.forEach((dot) => {
    dot.addEventListener('click', () => {
      currentIndex = parseInt(dot.getAttribute('data-index') || '0')
      updateCarousel()
    })
  })

  // 初始化
  updateCarousel()

  // 自動輪播（可選）
  // setInterval(() => {
  //   currentIndex = currentIndex === totalItems - 1 ? 0 : currentIndex + 1
  //   updateCarousel()
  // }, 5000)
</script>
